import socket
import struct
import time
from util import robtarget_to_string
import test_cam2


MOVE_L = 1
MOVE_J = 0

PRESSURE_ON = 1
PRESSURE_OFF = 0


home='[[391.67,3.28,502.07],[0.481577,-0.0149741,0.87627,-0.00325363],[0,-1,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'

nad_p0 = '[[351.54,130.76,53.61],[1.13512E-05,-0.00591942,-0.999982,-2.4026E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_p1 = '[[371.54,130.76,53.61],[1.13512E-05,-0.00591942,-0.999982,-2.4026E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_p2 = '[[391.54,130.76,53.61],[1.13512E-05,-0.00591942,-0.999982,-2.4026E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_p3 = '[[411.54,130.76,53.61],[1.13512E-05,-0.00591942,-0.999982,-2.4026E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'

nad_p4 = '[[351.54,160.76,53.61],[1.13512E-05,-0.00591942,-0.999982,-2.4026E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_p5 = '[[371.54,160.76,53.61],[1.13512E-05,-0.00591942,-0.999982,-2.4026E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_p6 = '[[391.54,160.76,53.61],[1.13512E-05,-0.00591942,-0.999982,-2.4026E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_p7 = '[[411.54,160.76,53.61],[1.13512E-05,-0.00591942,-0.999982,-2.4026E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'



p0 = '[[351.55,130.76,0.02],[6.92312E-06,-0.00591951,-0.999982,-1.23537E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
p1 = '[[371.55,130.76,0.02],[6.92312E-06,-0.00591951,-0.999982,-1.23537E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
p2 = '[[391.55,130.76,0.02],[6.92312E-06,-0.00591951,-0.999982,-1.23537E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
p3 = '[[411.55,130.76,0.02],[6.92312E-06,-0.00591951,-0.999982,-1.23537E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'

p4 = '[[351.55,160.76,0.02],[6.92312E-06,-0.00591951,-0.999982,-1.23537E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
p5 = '[[371.55,160.76,0.02],[6.92312E-06,-0.00591951,-0.999982,-1.23537E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
p6 = '[[391.55,160.76,0.02],[6.92312E-06,-0.00591951,-0.999982,-1.23537E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
p7 = '[[411.55,160.76,0.02],[6.92312E-06,-0.00591951,-0.999982,-1.23537E-06],[0,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'




o0 = '[[354.53,222.39,20.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o1 = '[[361.53,222.39,20.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o2 = '[[368.53,222.39,20.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o3 = '[[375.53,222.39,20.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'

o4 = '[[383.53,222.39,20.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o5 = '[[390.53,222.39,20.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o6 = '[[397.53,222.39,20.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o7 = '[[404.53,222.39,20.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'


nad_o0 = '[[355.03,222.39,40.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_o1 = '[[362.03,222.39,40.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_o2 = '[[369.03,222.39,40.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_o3 = '[[376.03,222.39,40.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'

nad_o4 = '[[384.03,222.39,40.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_o5 = '[[391.03,222.39,40.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_o6 = '[[398.03,222.39,40.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nad_o7 = '[[405.03,222.39,40.60],[0.62444,0.00579427,0.780961,-0.0118693],[0,0,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'


cam = '[[297.814, -253.845,60.08],[0.301421,0.119755,-0.922038,-0.211306],[-1,-1,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
cam_nad = '[[297.814, -253.845,70.08],[0.301421,0.119755,-0.922038,-0.211306],[-1,-1,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'

T1 = '[[353.85,-167.12,15.25],[5.38632E-06,0.000288104,-1,-5.84702E-06],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
T2 = '[[206.24,-165.94,15.25],[2.55885E-06,-0.000288227,1,2.73332E-06],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
T3 = '[[203.97,-374.12,15.25],[3.99066E-06,0.000314161,-1,-1.72328E-05],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'


sredina = '[[385.54,-13.26,167.04],[0.147483,0.0572503,0.987356,0.00991752],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
nova_sredina = '[[373.18,-180.92,123.41],[0.661848,-0.0034796,0.749597,-0.00696182],[-1,-1,0,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'

# o10 = '[[372.75,-44.12,28.54],[0.669464,0.00202693,0.742356,-0.0268804],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
# o11 = '[[383.35,-46.51,28.74],[0.669464,0.00200171,0.742356,-0.0268692],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
# o12 = '[[394.95,-48.71,29.94],[0.669461,0.001984,0.742359,-0.0268546],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
# o13 = '[[416.55,-55.91,29.94],[0.669459,0.00196787,0.742362,-0.0268422],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
# o20 = '[[336.74,-44.16,26.62],[0.669912,0.0177664,0.74212,-0.0126382],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
# o21 = '[[348.2,-36.16,27.81],[0.669914,0.0177519,0.742118,-0.0126554],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
# o22 = '[[361.6,-36.16,28.21],[0.669913,0.0177447,0.74212,-0.0126471],[-1,-1,0,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
# o23 = '[[406.56,-29.6,28.41],[0.669912,0.0177247,0.742121,-0.0126342],[-1,-1,0,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
# o24 = '[[405.76,-65.6,29.01],[0.669915,0.0177304,0.742118,-0.0126397],[-1,-1,0,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'


o10 = '[[373.18,-42.80,29.52],[0.661849,-0.0035148,0.749597,-0.00693328],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o11 = '[[383.78,-45.20,30.12],[0.661849,-0.00351808,0.749596,-0.00693167],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o12 = '[[394.78,-47.21,30.12],[0.661852,-0.00351681,0.749594,-0.00693318],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o13 = '[[416.78,-54.60,30.12],[0.661848,-0.00352871,0.749598,-0.0069227],[-1,-1,0,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o20 = '[[336.38,-43.80,26.72],[0.661846,-0.00352864,0.7496,-0.00692907],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o21 = '[[347.78,-35.20,28.09],[0.661846,-0.00352943,0.7496,-0.00692876],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o22 = '[[361.07,-35.20,28.29],[0.661845,-0.00352995,0.7496,-0.00692882],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o23 = '[[406.07,-28.40,28.84],[0.661845,-0.00353033,0.7496,-0.00693026],[-1,-1,-1,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'
o24 = '[[405.37,-64.80,28.69],[0.661844,-0.00353135,0.749601,-0.00692842],[-1,-1,0,1],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'

cam_check = '[[391.73,-279.12,223.81],[0.101973,0.140233,0.746136,-0.64282],[-1,-2,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];'


o_velike = [o10, o11, o12, o13, o20, o21, o22, o23, o24]
o = [o0, o1, o2, o3, o4, o5, o6, o7]
o_nad = [nad_o0, nad_o1, nad_o2, nad_o3, nad_o4, nad_o5, nad_o6, nad_o7]


program_basic = [
           [home, MOVE_J, PRESSURE_OFF],

           [nad_p0, MOVE_J, PRESSURE_OFF],
           [p0, MOVE_L, PRESSURE_ON],
           [nad_p0, MOVE_L, PRESSURE_ON],
           [nad_o0, MOVE_J, PRESSURE_ON],
           [o0, MOVE_J, PRESSURE_OFF],
           [nad_o0, MOVE_J, PRESSURE_OFF],
           

           [nad_p1, MOVE_J, PRESSURE_OFF],
           [p1, MOVE_L, PRESSURE_ON],
           [nad_p1, MOVE_L, PRESSURE_ON],
           [nad_o1, MOVE_J, PRESSURE_ON],
           [o1, MOVE_J, PRESSURE_OFF],
           [nad_o1, MOVE_J, PRESSURE_OFF],
           

           [nad_p2, MOVE_J, PRESSURE_OFF],
           [p2, MOVE_L, PRESSURE_ON],
           [nad_p2, MOVE_L, PRESSURE_ON],
           [nad_o2, MOVE_J, PRESSURE_ON],
           [o2, MOVE_J, PRESSURE_OFF],
           [nad_o2, MOVE_J, PRESSURE_OFF],
           

           [nad_p3, MOVE_J, PRESSURE_OFF],
           [p3, MOVE_L, PRESSURE_ON],
           [nad_p3, MOVE_L, PRESSURE_ON],
           [nad_o3, MOVE_J, PRESSURE_ON],
           [o3, MOVE_J, PRESSURE_OFF],
           [nad_o3, MOVE_J, PRESSURE_OFF],
           


           [nad_p4, MOVE_J, PRESSURE_OFF],
           [p4, MOVE_L, PRESSURE_ON],
           [nad_p4, MOVE_L, PRESSURE_ON],
           [nad_o4, MOVE_J, PRESSURE_ON],
           [o4, MOVE_J, PRESSURE_OFF],
           [nad_o4, MOVE_J, PRESSURE_OFF],
           

           [nad_p5, MOVE_J, PRESSURE_OFF],
           [p5, MOVE_L, PRESSURE_ON],
           [nad_p5, MOVE_L, PRESSURE_ON],
           [nad_o5, MOVE_J, PRESSURE_ON],
           [o5, MOVE_J, PRESSURE_OFF],
           [nad_o5, MOVE_J, PRESSURE_OFF],
           

           [nad_p6, MOVE_J, PRESSURE_OFF],
           [p6, MOVE_L, PRESSURE_ON],
           [nad_p6, MOVE_L, PRESSURE_ON],
           [nad_o6, MOVE_J, PRESSURE_ON],
           [o6, MOVE_J, PRESSURE_OFF],
           [nad_o6, MOVE_J, PRESSURE_OFF],
           

           [nad_p7, MOVE_J, PRESSURE_OFF],
           [p7, MOVE_L, PRESSURE_ON],
           [nad_p7, MOVE_L, PRESSURE_ON],
           [nad_o7, MOVE_J, PRESSURE_ON],
           [o7, MOVE_J, PRESSURE_OFF],
           [nad_o7, MOVE_J, PRESSURE_OFF],
           

           


           [home, MOVE_J, PRESSURE_OFF]
           
        ]

program_vision = [
    [home, MOVE_J, PRESSURE_OFF],
    0
]

program = program_vision
program_pointer = 0

tocke = []

def get_string_from_instruction(program, program_pointer):

    global tocke

    instruction = program[program_pointer]

    if type(instruction) != list:
        print("Generating new program from vision...")
        tocke = test_cam2.do_vision(vision=1)
        for j,i in enumerate(range(0, len(tocke), 2)):
            
            # program.append([tocke[i], MOVE_J, PRESSURE_OFF])
            # program.append([tocke[i+1], MOVE_L, PRESSURE_ON])
            # program.append([tocke[i], MOVE_L, PRESSURE_ON])
            # program.append([sredina, MOVE_J, PRESSURE_ON])
            # program.append([o_nad[k], MOVE_J, PRESSURE_ON])
            # program.append([o[k], MOVE_L, PRESSURE_OFF])
            # program.append([o_nad[k], MOVE_L, PRESSURE_OFF])
            # program.append([sredina, MOVE_J, PRESSURE_OFF])

            program.append([tocke[i], MOVE_J, PRESSURE_OFF])
            program.append([tocke[i+1], MOVE_L, PRESSURE_ON])
            program.append([tocke[i], MOVE_L, PRESSURE_ON])
            
            program.append([nova_sredina, MOVE_J, PRESSURE_ON])
            program.append([o_velike[j], MOVE_L, PRESSURE_OFF])
            program.append([nova_sredina, MOVE_L, PRESSURE_OFF])
            


            
            

            

        
        return -1

    return robtarget_to_string(instruction[0], pressure=instruction[2], moveL=instruction[1])




### Config ### =========================================================================================

global wait_time, send_type, ip, port

wait_time = 5 #s, koliko časa čakamo med poslanimi paketki
send_type = "80s" #poglej navodila za knjižnico struct


ip_rob = "192.168.125.1" #Server IP (npr robot)
server_port = 5000  #server port

send_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
send_socket.connect((ip_rob, server_port)) #uspostavimo povezavo s serverjem
time.sleep(0.5) #za vsak primer počakamo 0.5s





# =======================================================================================================

HOST = ""  # Standard loopback interface address (localhost)
PORT = 5001  # Port to listen on (non-privileged ports are > 1023)
print("Program started...")

with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.bind((HOST, PORT))
    s.listen()
    conn, addr = s.accept()
    with conn:
        print(f"Connected by {addr}")
        
        while True:
            data = conn.recv(1024)
            if data:
                print(data)
                #input("Press enter")
                send_data = get_string_from_instruction(program, program_pointer)
                if send_data == -1:
                    program_pointer += 1
                    send_data = get_string_from_instruction(program, program_pointer)
                    
                ba = struct.pack(send_type, send_data) #prevedemo številko v byte
                program_pointer += 1
                send_socket.send(ba) #pošljemo
                
                
            
                
            #conn.sendall(data)